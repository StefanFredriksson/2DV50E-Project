<!DOCTYPE html>
<html>
  <head>
    <title>PNaCl</title>
    <script src="../../js/timer.js"></script>
    <script type="text/javascript">
      FibonacciModule = null
      statusText = 'NO-STATUS'

      function moduleDidLoad () {
        FibonacciModule = document.querySelector('#array')
        updateStatus('SUCCESS')
        FibonacciModule.postMessage('Hello')
      }

      function handleMessage (message_event) {
        const date = new Date()
        const time = date.getTime()
        const execTime = message_event.data
        const obj = {
          tech: 'pnacl',
          app: 'array',
          time,
          execTime
        }
        socket.send(JSON.stringify(obj))
        window.close()
      }

      function pageDidLoad () {
        if (FibonacciModule === null) {
          updateStatus('LOADING...')
        } else {
          updateStatus()
        }
      }

      function updateStatus (opt_message) {
        if (opt_message) {
          statusText = opt_message
        }

        const statusField = document.querySelector('#statusField')

        if (statusField) {
          statusField.textContent = statusText
        }
      }
    </script>
  </head>
  <body onload="pageDidLoad()">
    <h1>PNaCl page</h1>
    <div id="listener">
      <script type="text/javascript">
        var listener = document.getElementById('listener')
        listener.addEventListener('load', moduleDidLoad, true)
        listener.addEventListener('message', handleMessage, true)
      </script>

      <embed
        id="array"
        width="0"
        height="0"
        src="array.nmf"
        type="application/x-pnacl"
      />
    </div>

    <h2>Status <code id="statusField">NO-STATUS</code></h2>
  </body>
</html>
